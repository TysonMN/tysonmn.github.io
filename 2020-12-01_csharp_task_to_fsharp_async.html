<!DOCTYPE html><html><head><title>Converting asynchronous cancellation from C# to F#</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="keywords" content="software, development, functional, programming, Tyson, Williams, Recommendation, CSharp, FSharp"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="src/assets/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons%7CMaterial+Icons+Outlined&amp;display=swap" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-176781099-1"></script><script>(function(){function gtag(){dataLayer.push(arguments);}function sendPageViewToGoogle(){gtag('js', new Date());gtag('config', 'UA-176781099-1', { 'page_path': location.pathname });}window.dataLayer = window.dataLayer || [];window.addEventListener("navigation", sendPageViewToGoogle);sendPageViewToGoogle();})();</script><link href="/dist/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/dist/bundle/codedoc-bundle.js"></script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Converting asynchronous cancellation from C# to F#"><meta property="og:type" content="article"><meta property="og:title" content="Converting asynchronous cancellation from C# to F#"><meta property="blog-tags" content="Recommendation, CSharp, FSharp"></head><body><div class="header-0-0-11"></div><div id="-codedoc-container" class="container"><script>window.source = {"base":"src/markdown","path":"2020-12-01_csharp_task_to_fsharp_async.md","namespace":"","title":{"base":"","connector":" | "}}</script><h1 class="h-0-0-4 "><span style=" 
      text-shadow: none; 
      font-size: 48px"><p>Converting asynchronous cancellation from C# to F#</p></span></h1><script id="AkqGdSorIn">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("AkqGdSorIn", "p0Awi9aICg3CVGLflzcWgA==", {"name":"Tyson Williams","date":"2020-12-01","avatar":"src/assets/images/TysonWilliams.jpg"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><p><em>Examples of how to convert asynchronous code involving cancellation from C# to F#.</em></p><p>Recently I was converting some asynchronous code from C# to F#.  I knew that cancellation tokens were treated differently, that F# "implicitly" handles the cancellation token, but it still took me longer than I expected to figure out the correct code.</p><p>Below are four typical examples of asynchronous code in C#.  Each is paired its behavioral equivalent (or nearly so) in F#, especially as it relates to cancellation.</p><p>This post is my contribution to the <a href="https://sergeytihon.com/2020/10/22/f-advent-calendar-in-english-2020/">F# Advent Calendar in English 2020</a>.  This holiday season, treat yourself by reading all the other great posts about F# by all the other great authors.</p><p>All code examples are available in their full and executable form <a href="https://github.com/TysonMN/tyson-williams-blog/tree/master/src/code/ConvertAsynchronousCode">here</a>.</p><h1 id="waiting" class="heading-0-0-5"><span class="anchor-0-0-6" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Waiting</h1><p>A non-blocking wait is typically achieved by calling <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.task.delay">Task.Delay</a> in C# and
<a href="https://fsharp.github.io/fsharp-core-docs/reference/fsharp-control-fsharpasync.html#Sleep">Async.Sleep</a> in F#.  To stop the asynchronous computation while waiting, the <code>CancellationToken</code> token must be explicitly passed to <code>Task.Delay</code>.  In contrast, the <code>CancellationToken</code> token is implicitly passed to <code>Async.Sleep</code>.</p><div class="tabs-0-0-33"><script id="rQMMkr_ftu">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("rQMMkr_ftu", "XFAat1a2hXyeIVp/sB99PQ==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div class="tab first selected" data-tab-title="C#" data-tab-id="C#"><pre class="with-bar"><code class="csharp -codedoc-code-snippet code-0-0-18" tabindex="0"><span class="wmbar-0-0-23"><span></span><span></span><span></span><span>Program.cs</span></span><div class="line-0-0-22  -codedoc-code-line" data-content="static async Task Foo(CancellationToken ct) {" id="code1-l1"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> ct<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  try {" id="code1-l2"><span class="lineCounter-0-0-19 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">try</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    Console.WriteLine(&quot;Starting&quot;);" id="code1-l3"><span class="lineCounter-0-0-19 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Starting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    await Task.Delay(1000, ct);" id="code1-l4"><span class="lineCounter-0-0-19 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> ct<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    Console.WriteLine(&quot;Waiting&quot;);" id="code1-l5"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Waiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    await Task.Delay(1000, ct);" id="code1-l6"><span class="lineCounter-0-0-19 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> ct<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    Console.WriteLine(&quot;Waiting&quot;);" id="code1-l7"><span class="lineCounter-0-0-19 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Waiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    await Task.Delay(1000, ct);" id="code1-l8"><span class="lineCounter-0-0-19 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> ct<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    Console.WriteLine(&quot;Waiting&quot;);" id="code1-l9"><span class="lineCounter-0-0-19 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Waiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    await Task.Delay(1000, ct);" id="code1-l10"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> ct<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    Console.WriteLine(&quot;Completed&quot;);" id="code1-l11"><span class="lineCounter-0-0-19 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Completed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  } catch (TaskCanceledException) {" id="code1-l12"><span class="lineCounter-0-0-19 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TaskCanceledException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    Console.WriteLine(&quot;Canceled&quot;);" id="code1-l13"><span class="lineCounter-0-0-19 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Canceled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  }" id="code1-l14"><span class="lineCounter-0-0-19 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="}" id="code1-l15"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="" id="code1-l16"><span class="lineCounter-0-0-19 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="static async Task<int> Main() {" id="code1-l17"><span class="lineCounter-0-0-19 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  using var cts = new CancellationTokenSource();" id="code1-l18"><span class="lineCounter-0-0-19 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  _ = Foo(cts.Token);" id="code1-l19"><span class="lineCounter-0-0-19 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  _ <span class="token operator">=</span> <span class="token function">Foo</span><span class="token punctuation">(</span>cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  await Task.Delay(2500);" id="code1-l20"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">2500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  cts.Cancel();" id="code1-l21"><span class="lineCounter-0-0-19 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  cts<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  _ = Console.ReadKey();" id="code1-l22"><span class="lineCounter-0-0-19 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  _ <span class="token operator">=</span> Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  return 0;" id="code1-l23"><span class="lineCounter-0-0-19 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="}" id="code1-l24"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre></div><div class="tab" data-tab-title="F#" data-tab-id="F#"><pre class="with-bar"><code class="fsharp -codedoc-code-snippet code-0-0-18" tabindex="0"><span class="wmbar-0-0-23"><span></span><span></span><span></span><span>Program.fs</span></span><div class="line-0-0-22  -codedoc-code-line" data-content="let foo () = async {" id="code2-l1"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">let</span> foo <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token computation-expression keyword">async</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  use! __ = Async.OnCancel(fun () -> Console.WriteLine &quot;Canceled&quot;)" id="code2-l2"><span class="lineCounter-0-0-19 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">use!</span> __ <span class="token operator">=</span> Async<span class="token punctuation">.</span><span class="token function">OnCancel</span><span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Canceled"</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Starting&quot;" id="code2-l3"><span class="lineCounter-0-0-19 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Starting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  do! Async.Sleep 1000" id="code2-l4"><span class="lineCounter-0-0-19 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">do</span><span class="token operator">!</span> Async<span class="token punctuation">.</span>Sleep <span class="token number">1000</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Waiting&quot;" id="code2-l5"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Waiting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  do! Async.Sleep 1000" id="code2-l6"><span class="lineCounter-0-0-19 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">do</span><span class="token operator">!</span> Async<span class="token punctuation">.</span>Sleep <span class="token number">1000</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Waiting&quot;" id="code2-l7"><span class="lineCounter-0-0-19 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Waiting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  do! Async.Sleep 1000" id="code2-l8"><span class="lineCounter-0-0-19 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">do</span><span class="token operator">!</span> Async<span class="token punctuation">.</span>Sleep <span class="token number">1000</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Waiting&quot;" id="code2-l9"><span class="lineCounter-0-0-19 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Waiting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  do! Async.Sleep 1000" id="code2-l10"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">do</span><span class="token operator">!</span> Async<span class="token punctuation">.</span>Sleep <span class="token number">1000</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Completed&quot;" id="code2-l11"><span class="lineCounter-0-0-19 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Completed"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="}" id="code2-l12"><span class="lineCounter-0-0-19 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="" id="code2-l13"><span class="lineCounter-0-0-19 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="[<EntryPoint>]" id="code2-l14"><span class="lineCounter-0-0-19 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">EntryPoint</span><span class="token punctuation">&gt;]</span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="let main _ =" id="code2-l15"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">let</span> main _ <span class="token operator">=</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  use cts = new CancellationTokenSource ()" id="code2-l16"><span class="lineCounter-0-0-19 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">use</span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CancellationTokenSource</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Async.Start (foo (), cts.Token)" id="code2-l17"><span class="lineCounter-0-0-19 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Async<span class="token punctuation">.</span>Start <span class="token punctuation">(</span>foo <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Async.Sleep 2500 |> Async.RunSynchronously" id="code2-l18"><span class="lineCounter-0-0-19 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Async<span class="token punctuation">.</span>Sleep <span class="token number">2500</span> <span class="token operator">|&gt;</span> Async<span class="token punctuation">.</span>RunSynchronously</div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  cts.Cancel ()" id="code2-l19"><span class="lineCounter-0-0-19 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  cts<span class="token punctuation">.</span>Cancel <span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.ReadKey () |> ignore" id="code2-l20"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>ReadKey <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore</div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  0" id="code2-l21"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token number">0</span></div><br></code></pre></div></div><p>(Normally I would use the <a href="https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/pattern-matching#wildcard-pattern">wildcard pattern</a> <code>_</code> in in place of <code>__</code> in the F# code, but <a href="https://github.com/dotnet/fsharp/issues/7775#issuecomment-735512911">that is not currently supported</a>.)</p><p>In both languages, this is the output.</p><div class="center-0-0-17"><p><img src="src/assets/images/cancellation_wait_wait_canceled.gif" alt="Waiting output"></p></div><p>If the call to <code>CancellationTokenSource.Cancel</code> is removed, then this is the output in both languages.</p><div class="center-0-0-17"><p><img src="src/assets/images/cancellation_completed.gif" alt="Waiting output"></p></div><h1 id="iscancellationrequested" class="heading-0-0-5"><span class="anchor-0-0-6" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>IsCancellationRequested</h1><p>It is possible to explicitly check if some asynchronous computation should be stopped via the instance property <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.cancellationtoken.iscancellationrequested"><code>CancellationToken.IsCancellationRequested</code></a>.  Of course an instance of <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.cancellationtoken"><code>CancellationToken</code></a> is required in order to call that property.  It is obvious how to do this in C# because the <code>CancellationToken</code> instance is explicitly available as a method argument.  In F#, the <code>CancellationToken</code> instance is obtained by calling <a href="https://fsharp.github.io/fsharp-core-docs/reference/fsharp-control-fsharpasync.html#CancellationToken"><code>Async.CancellationToken</code></a>.</p><div class="tabs-0-0-33"><script id="qyLZnucryn">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("qyLZnucryn", "XFAat1a2hXyeIVp/sB99PQ==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div class="tab first selected" data-tab-title="C#" data-tab-id="C#"><pre class="with-bar"><code class="csharp -codedoc-code-snippet code-0-0-18" tabindex="0"><span class="wmbar-0-0-23"><span></span><span></span><span></span><span>Program.cs</span></span><div class="line-0-0-22  -codedoc-code-line" data-content="static void BusyWait() {" id="code3-l1"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">BusyWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  foreach (var _ in Enumerable.Repeat(0, 150000000)) { }" id="code3-l2"><span class="lineCounter-0-0-19 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> _ <span class="token keyword">in</span> Enumerable<span class="token punctuation">.</span><span class="token function">Repeat</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">150000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="}" id="code3-l3"><span class="lineCounter-0-0-19 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="" id="code3-l4"><span class="lineCounter-0-0-19 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="static void Foo(CancellationToken ct) {" id="code3-l5"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> ct<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine(&quot;Starting&quot;);" id="code3-l6"><span class="lineCounter-0-0-19 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Starting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  BusyWait();" id="code3-l7"><span class="lineCounter-0-0-19 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token function">BusyWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine(&quot;Waiting&quot;);" id="code3-l8"><span class="lineCounter-0-0-19 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Waiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  if (ct.IsCancellationRequested) {" id="code3-l9"><span class="lineCounter-0-0-19 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ct<span class="token punctuation">.</span>IsCancellationRequested<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    Console.WriteLine(&quot;Canceled&quot;);" id="code3-l10"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Canceled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    return;" id="code3-l11"><span class="lineCounter-0-0-19 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  }" id="code3-l12"><span class="lineCounter-0-0-19 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  BusyWait();" id="code3-l13"><span class="lineCounter-0-0-19 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token function">BusyWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine(&quot;Waiting&quot;);" id="code3-l14"><span class="lineCounter-0-0-19 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Waiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  if (ct.IsCancellationRequested) {" id="code3-l15"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ct<span class="token punctuation">.</span>IsCancellationRequested<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    Console.WriteLine(&quot;Canceled&quot;);" id="code3-l16"><span class="lineCounter-0-0-19 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Canceled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    return;" id="code3-l17"><span class="lineCounter-0-0-19 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  }" id="code3-l18"><span class="lineCounter-0-0-19 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  BusyWait();" id="code3-l19"><span class="lineCounter-0-0-19 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token function">BusyWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine(&quot;Waiting&quot;);" id="code3-l20"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Waiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  if (ct.IsCancellationRequested) {" id="code3-l21"><span class="lineCounter-0-0-19 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ct<span class="token punctuation">.</span>IsCancellationRequested<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    Console.WriteLine(&quot;Canceled&quot;);" id="code3-l22"><span class="lineCounter-0-0-19 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Canceled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    return;" id="code3-l23"><span class="lineCounter-0-0-19 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  }" id="code3-l24"><span class="lineCounter-0-0-19 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  BusyWait();" id="code3-l25"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token function">BusyWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine(&quot;Completed&quot;);" id="code3-l26"><span class="lineCounter-0-0-19 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Completed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="}" id="code3-l27"><span class="lineCounter-0-0-19 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="" id="code3-l28"><span class="lineCounter-0-0-19 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="static async Task<int> Main() {" id="code3-l29"><span class="lineCounter-0-0-19 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  using var cts = new CancellationTokenSource();" id="code3-l30"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  _ = Task.Run(() => Foo(cts.Token));" id="code3-l31"><span class="lineCounter-0-0-19 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  _ <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Foo</span><span class="token punctuation">(</span>cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  await Task.Delay(1500);" id="code3-l32"><span class="lineCounter-0-0-19 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  cts.Cancel();" id="code3-l33"><span class="lineCounter-0-0-19 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  cts<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  _ = Console.ReadKey();" id="code3-l34"><span class="lineCounter-0-0-19 -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  _ <span class="token operator">=</span> Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  return 0;" id="code3-l35"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">35<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="}" id="code3-l36"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">36<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre></div><div class="tab" data-tab-title="F#" data-tab-id="F#"><pre class="with-bar"><code class="fsharp -codedoc-code-snippet code-0-0-18" tabindex="0"><span class="wmbar-0-0-23"><span></span><span></span><span></span><span>Program.fs</span></span><div class="line-0-0-22  -codedoc-code-line" data-content="let busyWait () =" id="code4-l1"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">let</span> busyWait <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  for _ in Enumerable.Repeat(0, 150000000) do ()" id="code4-l2"><span class="lineCounter-0-0-19 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">for</span> _ <span class="token keyword">in</span> Enumerable<span class="token punctuation">.</span><span class="token function">Repeat</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">150000000</span><span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="" id="code4-l3"><span class="lineCounter-0-0-19 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="let foo () = async {" id="code4-l4"><span class="lineCounter-0-0-19 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">let</span> foo <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token computation-expression keyword">async</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  let! ct = Async.CancellationToken" id="code4-l5"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">let!</span> ct <span class="token operator">=</span> Async<span class="token punctuation">.</span>CancellationToken</div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Starting&quot;" id="code4-l6"><span class="lineCounter-0-0-19 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Starting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  busyWait ()" id="code4-l7"><span class="lineCounter-0-0-19 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  busyWait <span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Waiting&quot;" id="code4-l8"><span class="lineCounter-0-0-19 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Waiting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  if (ct.IsCancellationRequested) then" id="code4-l9"><span class="lineCounter-0-0-19 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ct<span class="token punctuation">.</span>IsCancellationRequested<span class="token punctuation">)</span> <span class="token keyword">then</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    Console.WriteLine &quot;Canceled&quot;" id="code4-l10"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Canceled"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  else" id="code4-l11"><span class="lineCounter-0-0-19 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">else</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    busyWait ()" id="code4-l12"><span class="lineCounter-0-0-19 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    busyWait <span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    Console.WriteLine &quot;Waiting&quot;" id="code4-l13"><span class="lineCounter-0-0-19 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Waiting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    if (ct.IsCancellationRequested) then" id="code4-l14"><span class="lineCounter-0-0-19 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ct<span class="token punctuation">.</span>IsCancellationRequested<span class="token punctuation">)</span> <span class="token keyword">then</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="      Console.WriteLine &quot;Canceled&quot;" id="code4-l15"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Canceled"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    else" id="code4-l16"><span class="lineCounter-0-0-19 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">else</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="      busyWait ()" id="code4-l17"><span class="lineCounter-0-0-19 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      busyWait <span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="      Console.WriteLine &quot;Waiting&quot;" id="code4-l18"><span class="lineCounter-0-0-19 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Waiting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="      if (ct.IsCancellationRequested) then" id="code4-l19"><span class="lineCounter-0-0-19 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>ct<span class="token punctuation">.</span>IsCancellationRequested<span class="token punctuation">)</span> <span class="token keyword">then</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="        Console.WriteLine &quot;Canceled&quot;" id="code4-l20"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Canceled"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="      else" id="code4-l21"><span class="lineCounter-0-0-19 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">else</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="        busyWait ()" id="code4-l22"><span class="lineCounter-0-0-19 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        busyWait <span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="        Console.WriteLine &quot;Completed&quot;" id="code4-l23"><span class="lineCounter-0-0-19 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Completed"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="}" id="code4-l24"><span class="lineCounter-0-0-19 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="" id="code4-l25"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="[<EntryPoint>]" id="code4-l26"><span class="lineCounter-0-0-19 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">EntryPoint</span><span class="token punctuation">&gt;]</span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="let main _ =" id="code4-l27"><span class="lineCounter-0-0-19 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">let</span> main _ <span class="token operator">=</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  use cts = new CancellationTokenSource ()" id="code4-l28"><span class="lineCounter-0-0-19 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">use</span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CancellationTokenSource</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Async.Start (foo (), cts.Token)" id="code4-l29"><span class="lineCounter-0-0-19 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Async<span class="token punctuation">.</span>Start <span class="token punctuation">(</span>foo <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Async.Sleep 1500 |> Async.RunSynchronously" id="code4-l30"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Async<span class="token punctuation">.</span>Sleep <span class="token number">1500</span> <span class="token operator">|&gt;</span> Async<span class="token punctuation">.</span>RunSynchronously</div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  cts.Cancel ()" id="code4-l31"><span class="lineCounter-0-0-19 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  cts<span class="token punctuation">.</span>Cancel <span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.ReadKey () |> ignore" id="code4-l32"><span class="lineCounter-0-0-19 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>ReadKey <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore</div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  0" id="code4-l33"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token number">0</span></div><br></code></pre></div></div><p>(The exact number of iterations in the busy wait is not so special.  I adjusted it until I felt like it took about a second to execute on my machine.)</p><p>In both languages, this is the output.</p><div class="center-0-0-17"><p><img src="src/assets/images/cancellation_wait_wait_canceled.gif" alt="Waiting output"></p></div><p>If the call to <code>CancellationTokenSource.Cancel</code> is removed, then this is the output in both languages.</p><div class="center-0-0-17"><p><img src="src/assets/images/cancellation_completed.gif" alt="Waiting output"></p></div><h1 id="never-stop" class="heading-0-0-5"><span class="anchor-0-0-6" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Never stop</h1><p>Asynchronous code might not have a way to be stopped.  In C#, this is the default behavior.  When no <code>CancellationToken</code> is given to <code>Task.Delay</code>, it is as though <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.cancellationtoken.none"><code>CancellationToken.None</code></a> <a href="https://github.com/dotnet/runtime/blob/1edc35f8517bbb2fae8c0152de14bd105f9bac06/src/libraries/System.Private.CoreLib/src/System/Threading/Tasks/Task.cs#L5356">is</a> <a href="https://github.com/dotnet/runtime/blob/1edc35f8517bbb2fae8c0152de14bd105f9bac06/src/libraries/System.Private.CoreLib/src/System/Threading/Tasks/Task.cs#L5397">given</a> (since <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.cancellationtoken.none?view=net-5.0#remarks:~:text=You%20can%20also%20use%20the%20C%23%20default(CancellationToken)%20statement%20to%20create%20an%20empty%20cancellation%20token.">it is the default for its type</a>), which is a <code>CancellationToken</code> that cannot be canceled.  This is not the default behavior in F#, so <code>CancellationToken.None</code> must be explicitly given to <a href="https://fsharp.github.io/fsharp-core-docs/reference/fsharp-control-fsharpasync.html#Start"><code>Async.Start</code></a>.</p><div class="tabs-0-0-33"><script id="mKcwZWpGfF">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("mKcwZWpGfF", "XFAat1a2hXyeIVp/sB99PQ==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div class="tab first selected" data-tab-title="C#" data-tab-id="C#"><pre class="with-bar"><code class="csharp -codedoc-code-snippet code-0-0-18" tabindex="0"><span class="wmbar-0-0-23"><span></span><span></span><span></span><span>Program.cs</span></span><div class="line-0-0-22  -codedoc-code-line" data-content="static async Task Foo() {" id="code5-l1"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine(&quot;Starting&quot;);" id="code5-l2"><span class="lineCounter-0-0-19 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Starting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  await Task.Delay(1000);" id="code5-l3"><span class="lineCounter-0-0-19 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine(&quot;Waiting&quot;);" id="code5-l4"><span class="lineCounter-0-0-19 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Waiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  await Task.Delay(1000);" id="code5-l5"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine(&quot;Waiting&quot;);" id="code5-l6"><span class="lineCounter-0-0-19 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Waiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  await Task.Delay(1000);" id="code5-l7"><span class="lineCounter-0-0-19 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine(&quot;Waiting&quot;);" id="code5-l8"><span class="lineCounter-0-0-19 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Waiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  await Task.Delay(1000);" id="code5-l9"><span class="lineCounter-0-0-19 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine(&quot;Completed&quot;);" id="code5-l10"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Completed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="}" id="code5-l11"><span class="lineCounter-0-0-19 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="" id="code5-l12"><span class="lineCounter-0-0-19 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="static int Main() {" id="code5-l13"><span class="lineCounter-0-0-19 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  _ = Foo();" id="code5-l14"><span class="lineCounter-0-0-19 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  _ <span class="token operator">=</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  _ = Console.ReadKey();" id="code5-l15"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  _ <span class="token operator">=</span> Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  return 0;" id="code5-l16"><span class="lineCounter-0-0-19 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="}" id="code5-l17"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre></div><div class="tab" data-tab-title="F#" data-tab-id="F#"><pre class="with-bar"><code class="fsharp -codedoc-code-snippet code-0-0-18" tabindex="0"><span class="wmbar-0-0-23"><span></span><span></span><span></span><span>Program.fs</span></span><div class="line-0-0-22  -codedoc-code-line" data-content="let foo () = async {" id="code6-l1"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">let</span> foo <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token computation-expression keyword">async</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Starting&quot;" id="code6-l2"><span class="lineCounter-0-0-19 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Starting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  do! Async.Sleep 1000" id="code6-l3"><span class="lineCounter-0-0-19 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">do</span><span class="token operator">!</span> Async<span class="token punctuation">.</span>Sleep <span class="token number">1000</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Waiting&quot;" id="code6-l4"><span class="lineCounter-0-0-19 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Waiting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  do! Async.Sleep 1000" id="code6-l5"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">do</span><span class="token operator">!</span> Async<span class="token punctuation">.</span>Sleep <span class="token number">1000</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Waiting&quot;" id="code6-l6"><span class="lineCounter-0-0-19 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Waiting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  do! Async.Sleep 1000" id="code6-l7"><span class="lineCounter-0-0-19 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">do</span><span class="token operator">!</span> Async<span class="token punctuation">.</span>Sleep <span class="token number">1000</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Waiting&quot;" id="code6-l8"><span class="lineCounter-0-0-19 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Waiting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  do! Async.Sleep 1000" id="code6-l9"><span class="lineCounter-0-0-19 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">do</span><span class="token operator">!</span> Async<span class="token punctuation">.</span>Sleep <span class="token number">1000</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Completed&quot;" id="code6-l10"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Completed"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="}" id="code6-l11"><span class="lineCounter-0-0-19 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="" id="code6-l12"><span class="lineCounter-0-0-19 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="[<EntryPoint>]" id="code6-l13"><span class="lineCounter-0-0-19 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">EntryPoint</span><span class="token punctuation">&gt;]</span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="let main _ =" id="code6-l14"><span class="lineCounter-0-0-19 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">let</span> main _ <span class="token operator">=</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Async.Start (foo (), CancellationToken.None)" id="code6-l15"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Async<span class="token punctuation">.</span>Start <span class="token punctuation">(</span>foo <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CancellationToken<span class="token punctuation">.</span>None<span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.ReadKey () |> ignore" id="code6-l16"><span class="lineCounter-0-0-19 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>ReadKey <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore</div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  0" id="code6-l17"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token number">0</span></div><br></code></pre></div></div><p>In both languages, this is the output.</p><div class="center-0-0-17"><p><img src="src/assets/images/cancellation_completed.gif" alt="Waiting output"></p></div><p>The behavior of <code>Async.Start</code> and its variants when not given a <code>CancellationToken</code> is to use the one returned by the static property <a href="https://fsharp.github.io/fsharp-core-docs/reference/fsharp-control-fsharpasync.html#DefaultCancellationToken"><code>Async.DefaultCancellationToken</code></a>.  That instance can either be directly canceled by calling <code>CancellationTokenSource.Cancel</code> or indirectly canceled by calling <a href="https://fsharp.github.io/fsharp-core-docs/reference/fsharp-control-fsharpasync.html#CancelDefaultToken"><code>Async.CancelDefaultToken</code></a>.  Therefore, if the previous F# code did not explicitly pass <code>CancellationToken.None</code>, then it would be impure because of mutable static state, which is the worst kind of impurity!</p><pre class="with-bar"><code class="fsharp -codedoc-code-snippet code-0-0-18" tabindex="0"><span class="wmbar-0-0-23"><span></span><span></span><span></span><span>Program.fs</span></span><div class="line-0-0-22  -codedoc-code-line" data-content="let foo () = async {" id="code7-l1"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">let</span> foo <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token computation-expression keyword">async</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  use! __ = Async.OnCancel(fun () -> Console.WriteLine &quot;Canceled&quot;)" id="code7-l2"><span class="lineCounter-0-0-19 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">use!</span> __ <span class="token operator">=</span> Async<span class="token punctuation">.</span><span class="token function">OnCancel</span><span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Canceled"</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Starting&quot;" id="code7-l3"><span class="lineCounter-0-0-19 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Starting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  do! Async.Sleep 1000" id="code7-l4"><span class="lineCounter-0-0-19 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">do</span><span class="token operator">!</span> Async<span class="token punctuation">.</span>Sleep <span class="token number">1000</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Waiting&quot;" id="code7-l5"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Waiting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  do! Async.Sleep 1000" id="code7-l6"><span class="lineCounter-0-0-19 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">do</span><span class="token operator">!</span> Async<span class="token punctuation">.</span>Sleep <span class="token number">1000</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Waiting&quot;" id="code7-l7"><span class="lineCounter-0-0-19 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Waiting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  do! Async.Sleep 1000" id="code7-l8"><span class="lineCounter-0-0-19 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">do</span><span class="token operator">!</span> Async<span class="token punctuation">.</span>Sleep <span class="token number">1000</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Waiting&quot;" id="code7-l9"><span class="lineCounter-0-0-19 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Waiting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  do! Async.Sleep 1000" id="code7-l10"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">do</span><span class="token operator">!</span> Async<span class="token punctuation">.</span>Sleep <span class="token number">1000</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Completed&quot;" id="code7-l11"><span class="lineCounter-0-0-19 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Completed"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="}" id="code7-l12"><span class="lineCounter-0-0-19 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="" id="code7-l13"><span class="lineCounter-0-0-19 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="[<EntryPoint>]" id="code7-l14"><span class="lineCounter-0-0-19 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">EntryPoint</span><span class="token punctuation">&gt;]</span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="let main _ =" id="code7-l15"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">let</span> main _ <span class="token operator">=</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  //Async.Start (foo (), CancellationToken.None)" id="code7-l16"><span class="lineCounter-0-0-19 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">//Async.Start (foo (), CancellationToken.None)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Async.Start (foo ())" id="code7-l17"><span class="lineCounter-0-0-19 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Async<span class="token punctuation">.</span>Start <span class="token punctuation">(</span>foo <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Async.Sleep 2500 |> Async.RunSynchronously" id="code7-l18"><span class="lineCounter-0-0-19 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Async<span class="token punctuation">.</span>Sleep <span class="token number">2500</span> <span class="token operator">|&gt;</span> Async<span class="token punctuation">.</span>RunSynchronously</div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Async.CancelDefaultToken ()" id="code7-l19"><span class="lineCounter-0-0-19 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Async<span class="token punctuation">.</span>CancelDefaultToken <span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.ReadKey () |> ignore" id="code7-l20"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>ReadKey <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore</div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  0" id="code7-l21"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token number">0</span></div><br></code></pre><p>This is the output.</p><div class="center-0-0-17"><p><img src="src/assets/images/cancellation_wait_wait_canceled.gif" alt="Waiting output"></p></div><p>If <code>CancellationToken.None</code> is given to <code>Async.Start</code>, then canceling the default token has no effect, and the original behavior is restored.</p><h1 id="loop" class="heading-0-0-5"><span class="anchor-0-0-6" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Loop</h1><p>Asynchronous code might contain a loop.  If some corresponding asynchronous computation should be stopped, then it is reasonable to also exit the loop.  In C#, this must be done explicitly by calling <code>CancellationToken.IsCancellationRequested</code> in the loop's termination condition, which is similar to the <a href="#iscancellationrequested">IsCancellationRequested example</a>.  In F#, this is done implicitly, which is similar to the <a href="#waiting">Waiting example</a>.</p><div class="tabs-0-0-33"><script id="_bCzjNHZWa">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("_bCzjNHZWa", "XFAat1a2hXyeIVp/sB99PQ==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div class="tab first selected" data-tab-title="C#" data-tab-id="C#"><pre class="with-bar"><code class="csharp -codedoc-code-snippet code-0-0-18" tabindex="0"><span class="wmbar-0-0-23"><span></span><span></span><span></span><span>Program.cs</span></span><div class="line-0-0-22  -codedoc-code-line" data-content="static void BusyWait() {" id="code8-l1"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">BusyWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  foreach (var _ in Enumerable.Repeat(0, 150000000)) { }" id="code8-l2"><span class="lineCounter-0-0-19 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> _ <span class="token keyword">in</span> Enumerable<span class="token punctuation">.</span><span class="token function">Repeat</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">150000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="}" id="code8-l3"><span class="lineCounter-0-0-19 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="" id="code8-l4"><span class="lineCounter-0-0-19 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="static void Foo(CancellationToken ct) {" id="code8-l5"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> ct<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine(&quot;Starting&quot;);" id="code8-l6"><span class="lineCounter-0-0-19 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Starting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  var i = 0;" id="code8-l7"><span class="lineCounter-0-0-19 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name"><span class="token keyword">var</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  while (!ct.IsCancellationRequested &amp;&amp; i < 3) {" id="code8-l8"><span class="lineCounter-0-0-19 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>ct<span class="token punctuation">.</span>IsCancellationRequested <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    BusyWait();" id="code8-l9"><span class="lineCounter-0-0-19 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token function">BusyWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    Console.WriteLine(&quot;Waiting&quot;);" id="code8-l10"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Waiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    i++;" id="code8-l11"><span class="lineCounter-0-0-19 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    i<span class="token operator">++</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  }" id="code8-l12"><span class="lineCounter-0-0-19 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  BusyWait();" id="code8-l13"><span class="lineCounter-0-0-19 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token function">BusyWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  if (ct.IsCancellationRequested)" id="code8-l14"><span class="lineCounter-0-0-19 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ct<span class="token punctuation">.</span>IsCancellationRequested<span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    Console.WriteLine(&quot;Canceled&quot;);" id="code8-l15"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Canceled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  else" id="code8-l16"><span class="lineCounter-0-0-19 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">else</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    Console.WriteLine(&quot;Completed&quot;);" id="code8-l17"><span class="lineCounter-0-0-19 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Completed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="}" id="code8-l18"><span class="lineCounter-0-0-19 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="" id="code8-l19"><span class="lineCounter-0-0-19 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="static async Task<int> Main() {" id="code8-l20"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  using var cts = new CancellationTokenSource();" id="code8-l21"><span class="lineCounter-0-0-19 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  _ = Task.Run(() => Foo(cts.Token));" id="code8-l22"><span class="lineCounter-0-0-19 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  _ <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Foo</span><span class="token punctuation">(</span>cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  await Task.Delay(1500);" id="code8-l23"><span class="lineCounter-0-0-19 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  cts.Cancel();" id="code8-l24"><span class="lineCounter-0-0-19 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  cts<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  _ = Console.ReadKey();" id="code8-l25"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  _ <span class="token operator">=</span> Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  return 0;" id="code8-l26"><span class="lineCounter-0-0-19 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="}" id="code8-l27"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre></div><div class="tab" data-tab-title="F#" data-tab-id="F#"><pre class="with-bar"><code class="fsharp -codedoc-code-snippet code-0-0-18" tabindex="0"><span class="wmbar-0-0-23"><span></span><span></span><span></span><span>Program.fs</span></span><div class="line-0-0-22  -codedoc-code-line" data-content="let busyWait () =" id="code9-l1"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">let</span> busyWait <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  for _ in Enumerable.Repeat(0, 150000000) do ()" id="code9-l2"><span class="lineCounter-0-0-19 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">for</span> _ <span class="token keyword">in</span> Enumerable<span class="token punctuation">.</span><span class="token function">Repeat</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">150000000</span><span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="" id="code9-l3"><span class="lineCounter-0-0-19 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="let foo () = async {" id="code9-l4"><span class="lineCounter-0-0-19 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">let</span> foo <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token computation-expression keyword">async</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  use! __ = Async.OnCancel(fun () -> Console.WriteLine &quot;Canceled&quot;)" id="code9-l5"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">use!</span> __ <span class="token operator">=</span> Async<span class="token punctuation">.</span><span class="token function">OnCancel</span><span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Canceled"</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Starting&quot;" id="code9-l6"><span class="lineCounter-0-0-19 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Starting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  let mutable i = 0" id="code9-l7"><span class="lineCounter-0-0-19 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">let</span> <span class="token keyword">mutable</span> i <span class="token operator">=</span> <span class="token number">0</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  while (i < 3) do" id="code9-l8"><span class="lineCounter-0-0-19 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">do</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    busyWait ()" id="code9-l9"><span class="lineCounter-0-0-19 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    busyWait <span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    Console.WriteLine &quot;Waiting&quot;" id="code9-l10"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Waiting"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="    i <- i + 1" id="code9-l11"><span class="lineCounter-0-0-19 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    i <span class="token operator">&lt;-</span> i <span class="token operator">+</span> <span class="token number">1</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  busyWait ()" id="code9-l12"><span class="lineCounter-0-0-19 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  busyWait <span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.WriteLine &quot;Completed&quot;" id="code9-l13"><span class="lineCounter-0-0-19 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>WriteLine <span class="token string">"Completed"</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="}" id="code9-l14"><span class="lineCounter-0-0-19 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="" id="code9-l15"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="[<EntryPoint>]" id="code9-l16"><span class="lineCounter-0-0-19 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">EntryPoint</span><span class="token punctuation">&gt;]</span></span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="let main _ =" id="code9-l17"><span class="lineCounter-0-0-19 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">let</span> main _ <span class="token operator">=</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  use cts = new CancellationTokenSource ()" id="code9-l18"><span class="lineCounter-0-0-19 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">use</span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CancellationTokenSource</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Async.Start (foo (), cts.Token)" id="code9-l19"><span class="lineCounter-0-0-19 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Async<span class="token punctuation">.</span>Start <span class="token punctuation">(</span>foo <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Async.Sleep 1500 |> Async.RunSynchronously" id="code9-l20"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Async<span class="token punctuation">.</span>Sleep <span class="token number">1500</span> <span class="token operator">|&gt;</span> Async<span class="token punctuation">.</span>RunSynchronously</div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  cts.Cancel ()" id="code9-l21"><span class="lineCounter-0-0-19 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  cts<span class="token punctuation">.</span>Cancel <span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  Console.ReadKey () |> ignore" id="code9-l22"><span class="lineCounter-0-0-19 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  Console<span class="token punctuation">.</span>ReadKey <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore</div><br><div class="line-0-0-22  -codedoc-code-line" data-content="  0" id="code9-l23"><span class="lineCounter-0-0-19 prim -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token number">0</span></div><br></code></pre></div></div><p>The output differs slightly.  In C#, clearly <code>Waiting</code> is never printed after <code>Canceled</code>.  In F#, the callback given to <a href="https://fsharp.github.io/fsharp-core-docs/reference/fsharp-control-fsharpasync.html#OnCancel"><code>Async.OnCancel</code></a> is executed shortly after <code>CancellationTokenSource.Cancel</code> is called, which prints <code>Canceled</code>.  In the meantime, the busy wait is still executing.  When that is done, the current iteration of the loop is finished, which prints <code>Waiting</code>.</p><div class="center-0-0-17"><p><img src="src/assets/images/cancellation_wait_wait_canceled.gif" alt="Waiting output">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<img src="src/assets/images/cancellation_wait_canceled_wait.gif" alt="Waiting output"></p><p>C# output
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
F# output</p></div><p>I did not know that F# considers stopping asynchronous computations after each loop iteration until I was part way through writing this post.  I looked but failed to find this behavior described in documentation.  Please share a link in a comment if you know of such documentation.</p><blockquote><p>Added 2021-03-01</p><p>I still haven't found any documentation on the matter, but I have statically verified this behavior (that I experienced at runtime).  A <code>while</code> loop inside an <code>async</code> computational expression becomes a call to to <a href="https://github.com/dotnet/fsharp/blob/89ad3715a2a3502090218916b698dcf0fcbd59c9/src/fsharp/FSharp.Core/async.fs#L1068">this <code>While</code> method</a>,</p><ul><li>which calls <a href="https://github.com/dotnet/fsharp/blob/89ad3715a2a3502090218916b698dcf0fcbd59c9/src/fsharp/FSharp.Core/async.fs#L591"><code>CreateWhileAsync</code></a>,</li><li>which calls <a href="https://github.com/dotnet/fsharp/blob/89ad3715a2a3502090218916b698dcf0fcbd59c9/src/fsharp/FSharp.Core/async.fs#L525"><code>CreateBindAsync</code></a>,</li><li>which calls <a href="https://github.com/dotnet/fsharp/blob/89ad3715a2a3502090218916b698dcf0fcbd59c9/src/fsharp/FSharp.Core/async.fs#L461"><code>Bind</code></a>,</li><li>which <a href="https://github.com/dotnet/fsharp/blob/89ad3715a2a3502090218916b698dcf0fcbd59c9/src/fsharp/FSharp.Core/async.fs#L462-L465">checks if the <code>CancellationToken</code> was cancelled</a>.</li></ul></blockquote><p>If the call to <code>CancellationTokenSource.Cancel</code> is removed, then this is the output in both languages.</p><div class="center-0-0-17"><p><img src="src/assets/images/cancellation_completed.gif" alt="Waiting output"></p></div><p>Suppose the C# code never checked <code>CancellationToken.IsCancellationRequested</code>.  Then the F# code would need to replace the loop with <a href="https://en.wikipedia.org/wiki/Tail_call">tail recursion</a>.  This is conceptually similar to the <a href="#never-stop">Never Stop example</a> in that the F# code needs to explicitly avoid implicit calls to <code>CancellationToken.IsCancellationRequested</code>.</p><hr><script id="ZGbAgw_qOU">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("ZGbAgw_qOU", "2MLT5TonCcGV2RS0qfgUoA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><h1 id="tags" class="heading-0-0-5"><span class="anchor-0-0-6" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Tags</h1><p>The <a href="https://connect-platform.github.io/coding-blog-plugin/tags">tags feature of Coding Blog Plugin</a> is still being developed.  Eventually the tags will link somewhere.</p><p><a class="tag-0-0-7" data-page-tag="Recommendation"><code><span class="indicator-0-0-8">#</span>Recommendation</code></a> <a class="tag-0-0-7" data-page-tag="CSharp"><code><span class="indicator-0-0-8">#</span>CSharp</code></a> <a class="tag-0-0-7" data-page-tag="FSharp"><code><span class="indicator-0-0-8">#</span>FSharp</code></a></p><h1 id="comments" class="heading-0-0-5"><span class="anchor-0-0-6" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Comments</h1><div class="darklight-0-0-10"><div class="light"><div class="utterancesTransparentIframe-0-0-9"><script src="https://utteranc.es/client.js" data-repo="TysonMN/tyson-williams-blog" data-issue-term="pathname" data-label="comments" data-theme="github-light" crossorigin="anonymous" async=""></script></div></div><div class="dark"><div class="utterancesTransparentIframe-0-0-9"><script src="https://utteranc.es/client.js" data-repo="TysonMN/tyson-williams-blog" data-issue-term="pathname" data-label="comments" data-theme="icy-dark" crossorigin="anonymous" async=""></script></div></div></div><div class="contentnav-0-0-16" data-no-search=""><a href="#waiting" class="h1" data-content-highlight="waiting">Waiting</a><a href="#iscancellationrequested" class="h1" data-content-highlight="iscancellationrequested">IsCancellationRequested</a><a href="#never-stop" class="h1" data-content-highlight="never-stop">Never stop</a><a href="#loop" class="h1" data-content-highlight="loop">Loop</a><a href="#tags" class="h1" data-content-highlight="tags">Tags</a><a href="#comments" class="h1" data-content-highlight="comments">Comments</a></div></div><div id="-codedoc-toc" class="toc-0-0-13"><div class="content-0-0-14"><p><a href="/">Home</a>
<a href="/about">About</a>
<a href="/archive">Archive</a></p><marker><hr>
Feeds

</marker><ul><li><p><a href="https://tysonwilliams.coding.blog/_feed.atom">Atom</a></p></li><li><p><a href="https://tysonwilliams.coding.blog/_feed.rss">RSS</a></p></li><li><p><a href="https://tysonwilliams.coding.blog/_feed.json">JSON</a></p></li></ul><marker><iframe src="https://github.com/sponsors/TysonMN/button" title="Sponsor TysonMN" style="height:35px;width:85%;max-width:150px;background:transparent"></iframe></marker></div></div><div class="footer-0-0-12"><div class="left"><script id="gvglqgpC_Q">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("gvglqgpC_Q", "p8WGnNNmUFWz3ptY9ZmULw==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="OeYvsvUQuA">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("OeYvsvUQuA", "KBQUJYsHOc+D2NijTZqrhg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="SiSnpuAENa">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("SiSnpuAENa", "B3suto2Gvc7DIqwAJrf1oQ==", {"namespace":""});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>